# Wix Self-Hosted App Setup Guide (2025 Method)

## The Issue - SOLVED ‚úÖ

The "Missing instance token" error occurs because the Dashboard Page extension is not properly configured in Wix. According to the **2025 Wix documentation**, Wix automatically appends the `instance` query parameter to your iframe URL - you don't need to add `{instance}` manually.

## The 2025 Solution

### Step 1: Configure Dashboard Page Extension in Wix

1. **Go to Wix Developers**
   - Navigate to https://dev.wix.com
   - Open your app (Ultimate Optimizer App)

2. **Add Dashboard Page Extension**
   - Click **Extensions** in the left sidebar
   - Click **+ Create Extension**
   - Select **Dashboard Page**

3. **Configure the Extension**
   Fill in these fields:
   
   - **Name:** `Ultimate Optimizer` (internal name)
   - **Extension ID:** (auto-generated by Wix)
   - **iFrame URL:** `https://ultimate-optimizer-app.onrender.com/dashboard`
     - ‚ö†Ô∏è **Important:** Just the base URL - NO `{instance}` parameter needed!
     - Wix automatically appends `?instance=<token>` when loading the iframe
   - **Relative route:** `dashboard`
   - **Page name:** `Ultimate Optimizer` (appears in sidebar)

4. **Save the Extension**
   - Click **Save**
   - The extension is now configured

### Step 2: Install/Reinstall the App

1. Go to your Wix test site
2. If the app is already installed:
   - Uninstall it first
   - Then reinstall it
3. If not installed:
   - Install the app from your app dashboard or test URL

### Step 3: Access the App

1. Open your Wix site dashboard
2. Look for **Ultimate Optimizer** in the sidebar (under Apps section)
3. Click on it
4. The app should load without the "Missing instance token" error

## How It Works (2025 Method)

According to the official Wix 2025 documentation:

> "Wix provides iframes with an encoded instance query parameter. This is relevant for self-hosted dashboard pages, dashboard plugins, settings panels, and external links."

**What happens:**
1. You configure the Dashboard Page with just the base URL
2. When a user opens your app, Wix automatically appends `?instance=<signed_token>`
3. Your frontend reads the `instance` parameter from the URL
4. Your backend verifies the signed token and extracts the `instanceId`

**Example:**
- You configure: `https://ultimate-optimizer-app.onrender.com/dashboard`
- Wix loads: `https://ultimate-optimizer-app.onrender.com/dashboard?instance=eyJpbnN0YW5jZUlkIjoiLi4uIn0.abc123...`

## Code Changes Made

### 1. Simplified AuthContext
- Removed Wix SDK dependency (not needed for 2025 method)
- Directly reads `instance` parameter from URL
- Uses sessionStorage for internal navigation
- Added detailed debug logging

### 2. Removed Wix SDK Script
- Removed `<script src="...wix.min.js">` from index.html
- Not needed with the 2025 approach

### 3. Updated Error Messages
- Shows correct 2025 setup instructions
- Explains that Wix automatically appends the instance parameter

## Verification Checklist

After deploying the updated code:

- [ ] Dashboard Page extension is configured in Wix
- [ ] iFrame URL is set to: `https://ultimate-optimizer-app.onrender.com/dashboard`
- [ ] Extension is saved
- [ ] App is reinstalled on test site
- [ ] App appears in sidebar
- [ ] Opening app shows no "Missing instance token" error
- [ ] Browser console shows: `‚úÖ Instance token found in URL`

## Debug Information

If you still see the error, check the browser console (F12):

**What you should see:**
```
üîç Checking for instance token...
Current URL: https://ultimate-optimizer-app.onrender.com/dashboard?instance=eyJ...
Query params: ?instance=eyJ...
Instance param: ‚úÖ Found
‚úÖ Instance token found in URL
```

**If you see this instead:**
```
‚ùå No instance token found
```

**Then:**
1. The Dashboard Page extension is not configured
2. You're accessing the app directly (not through Wix dashboard)
3. The app needs to be reinstalled

## Key Differences from Old Method

| Old Method (Pre-2025) | New Method (2025) |
|----------------------|-------------------|
| Required `{instance}` placeholder | Wix auto-appends instance parameter |
| Needed Wix SDK script | No SDK needed |
| Complex token retrieval | Simple URL parameter read |
| Multiple fallback methods | Single source of truth |

## References

From the Wix 2025 documentation:

> **iframe**
> 
> Wix provides iframes with an encoded instance query parameter. This is relevant for self-hosted dashboard pages, dashboard plugins, settings panels, and external links.
> 
> To identify the app instance from an iframe:
> 1. Retrieve the instance query parameter from the URL.
> 2. Pass the instance value as the token to Token Info.
> 3. (Optional) Use the returned instanceId to create an app access token and call Get App Instance.

Source: Wix Self-Hosted App Documentation (2025)

## Next Steps

1. **Deploy the updated frontend** to Render
2. **Configure the Dashboard Page extension** in Wix (as described above)
3. **Reinstall the app** on your test site
4. **Test the app** - it should work without errors!

The instance token will now be automatically provided by Wix when users access your app through the dashboard.
